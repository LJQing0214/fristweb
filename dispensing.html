<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配药监控 - 中药配药系统</title>
    <style>
        body {
            margin: 0;
            background: #f8f9fa;
            font-family: '微软雅黑', Arial, sans-serif;
        }
        #nav-menu-container {
            width: 220px;
            float: left;
            min-height: 100vh;
            background: #253445;
        }
        .main-content {
            margin-left: 220px;
            padding: 40px 60px;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .info-bar {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
            align-items: center;
            flex-wrap: wrap;
        }
        .info-item {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            padding: 12px 24px;
            font-size: 15px;
            color: #333;
            min-width: 120px;
            margin-bottom: 8px;
        }
        .info-label {
            color: #888;
            font-size: 13px;
            margin-right: 6px;
        }
        .title {
            color: #3ca14b;
            font-size: 22px;
            margin-bottom: 18px;
            font-weight: bold;
        }
        .card-group {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 24px;
            margin-bottom: 0;
        }
        .progress-card {
            margin-bottom: 0;
        }
        .progress-label {
            color: #888;
            font-size: 14px;
            margin-bottom: 6px;
        }
        .progress-bar-bg {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3ca14b 60%, #6fdc8c 100%);
            border-radius: 5px;
            transition: width 0.4s;
        }
        .progress-bar.finished {
            background: linear-gradient(90deg, #4a90e2 60%, #8ec6f7 100%);
        }
        .progress-bar.error {
            background: linear-gradient(90deg, #e94f4f 60%, #f7b6b6 100%);
        }
        .task-card {
            margin-bottom: 0;
        }
        .task-title {
            font-size: 16px;
            color: #3ca14b;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .task-desc {
            font-size: 15px;
            margin-bottom: 18px;
            color: #333;
        }
        .weights {
            display: flex;
            gap: 40px;
            margin-top: 8px;
        }
        .weight-block {
            flex: 1;
            background: #f6faf6;
            border-radius: 8px;
            padding: 16px 0;
            text-align: center;
        }
        .weight-label {
            color: #888;
            font-size: 14px;
            margin-bottom: 6px;
        }
        .weight-value {
            font-size: 28px;
            color: #3ca14b;
            font-weight: bold;
        }
        .weight-value.error {
            color: #e94f4f;
        }
        .weight-value.finished {
            color: #4a90e2;
        }
        .detail-card {
            margin-bottom: 0;
        }
        .detail-title {
            font-size: 16px;
            color: #3ca14b;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .detail-card table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        .detail-card th, .detail-card td {
            padding: 8px 12px;
            text-align: center;
            font-size: 15px;
        }
        .detail-card th {
            background: #f6faf6;
            color: #3ca14b;
            font-weight: bold;
        }
        .detail-card tr.active {
            background: #eaf7ea;
        }
        .detail-card tr.finished {
            background: #eaf0fa;
        }
        .detail-card tr.error {
            background: #faeaea;
        }
        .status-running {
            color: #3ca14b;
            font-weight: bold;
        }
        .status-wait {
            color: #b0b8c1;
        }
        .status-finished {
            color: #4a90e2;
            font-weight: bold;
        }
        .status-error {
            color: #e94f4f;
            font-weight: bold;
        }
        .btn-action {
            padding: 7px 18px;
            font-size: 15px;
            border-radius: 20px;
            border: none;
            color: #fff;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        .btn-pause {
            background: linear-gradient(90deg, #2196F3 60%, #42A5F5 100%);
        }
        .btn-pause:hover {
            background: linear-gradient(90deg, #1976D2 60%, #64B5F6 100%);
        }
        .btn-restart {
            background: linear-gradient(90deg, #e53935 60%, #ff5252 100%);
        }
        .btn-restart:hover {
            background: linear-gradient(90deg, #b71c1c 60%, #ff867f 100%);
        }
        @media (max-width: 900px) {
            #nav-menu-container {
                width: 100%;
                float: none;
                min-height: unset;
            }
            .main-content {
                margin-left: 0;
                padding: 20px 8px;
            }
            .info-bar {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="nav-menu-container"></div>
    <div class="main-content">
        <!-- 顶部信息区 -->
        <div class="info-bar">
            <div class="info-item"><span class="info-label">处方号：</span><span id="prescriptionId">--</span></div>
            <div class="info-item"><span class="info-label">患者：</span><span id="patientName">--</span></div>
            <div class="info-item"><span class="info-label">操作员：</span><span id="operator">admin</span></div>
            <div class="info-item"><span class="info-label">时间：</span><span id="dispenseTime">--</span></div>
        </div>
        <h2 class="title">配药过程监控</h2>
        <div class="card-group">
            <div class="card progress-card" style="position:relative;">
                <div style="position:absolute;top:18px;right:24px;display:flex;gap:12px;z-index:2;">
                    <button id="pauseBtn" class="btn-action btn-pause">暂停配药</button>
                    <button id="restartBtn" class="btn-action btn-restart">重新配药</button>
                </div>
                <div>已配制：第 <b id="currentCopy">1</b> / <b id="totalCopy">1</b> 份</div>
                <div class="progress-label">总体进度</div>
                <div class="progress-bar-bg"><div class="progress-bar" id="overallProgressBar" style="width: 0%"></div></div>
            </div>
            <!-- 删除“当前任务”卡片HTML -->
            <div class="card detail-card">
                <div class="detail-title">药单详情</div>
                <table>
                    <thead>
                        <tr>
                            <th>中药名称</th>
                            <th>应称每份克数</th>
                            <th>实际克数</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="prescriptionDetail">
                        <!-- JS填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="ws-client.js"></script>
    <script>
        // 动态加载菜单
        fetch('menu.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('nav-menu-container').innerHTML = html;
                highlightActiveMenu();
            });

        function highlightActiveMenu() {
            const currentPage = window.location.pathname.split('/').pop();
            const menuItems = document.querySelectorAll('.nav-menu a:not(.logout)');
            menuItems.forEach(item => {
                if (item.getAttribute('href') === currentPage) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // 退出登录函数
        window.logout = function() {
            localStorage.removeItem('isLoggedIn');
            window.location.href = 'login.html';
        };

        // --- WebSocket 监听配药任务推送 ---
        const ws = new WebSocket('ws://' + window.location.hostname + ':3000');
        ws.onopen = function() {
            console.log('WebSocket已连接');
        };
        ws.onmessage = function(event) {
            console.log('WS收到消息:', event.data);
            const msg = JSON.parse(event.data);
            if (msg.type === 'dispense' || msg.type === 'dispensingUpdate') {
                renderDispensing(msg.data);
            }
            if (msg.type === 'finish') {
                alert(`药单${msg.prescription_id || msg.id || ''}已配完！`);
                // 可选：清空界面或显示等待新任务
            }
        };
        ws.onerror = function(e) {
            console.error('WebSocket错误', e);
        };

        // 页面加载时自动获取当前配药任务
        window.onload = function() {
            fetch('/api/currentDispense')
                .then(res => res.json())
                .then(data => {
                    console.log('当前配药任务:', data);
                    if (data && typeof data === 'object' && data.id) {
                        renderDispensingStarted(data);
                    } else {
                        // 无配药任务时，清空界面
                        document.getElementById('prescriptionId').textContent = '--';
                        document.getElementById('patientName').textContent = '--';
                        document.getElementById('dispenseTime').textContent = '--';
                        document.getElementById('currentCopy').textContent = 0;
                        document.getElementById('totalCopy').textContent = 0;
                        document.getElementById('overallProgressBar').style.width = '0%';
                        const detailBody = document.getElementById('prescriptionDetail');
                        if (detailBody) detailBody.innerHTML = '';
                        // 可选：显示暂无配药任务提示
                        let noTask = document.getElementById('noTaskMsg');
                        if (!noTask) {
                            noTask = document.createElement('div');
                            noTask.id = 'noTaskMsg';
                            noTask.style = 'color:#888;margin:30px 0 0 0;font-size:18px;text-align:center;';
                            noTask.textContent = '暂无配药任务';
                            document.querySelector('.main-content').appendChild(noTask);
                        }
                    }
                });
        };

        // 当一个新的配药任务开始时，初始化整个监控界面
        function renderDispensingStarted(data) {
            console.log('调用了renderDispensingStarted', data);
            document.getElementById('prescriptionId').textContent = data.id || '--';
            document.getElementById('patientName').textContent = data.patientName || '--';
            document.getElementById('dispenseTime').textContent = new Date().toLocaleString();
            document.getElementById('totalCopy').textContent = data.copies || 1;
            // 渲染药单详情表格
            const detailBody = document.getElementById('prescriptionDetail');
            detailBody.innerHTML = '';
            if (data.medicines && data.medicines.length > 0) {
                data.medicines.forEach(med => {
                    const tr = document.createElement('tr');
                    tr.id = 'med-' + med.name;
                    tr.innerHTML = `
                        <td>${med.name}</td>
                        <td>${med.weight}g</td>
                        <td>--</td>
                        <td class="status-wait">待配</td>
                    `;
                    detailBody.appendChild(tr);
                });
            }
            // 只在未收到任何进度数据时 currentCopy=0
            document.getElementById('currentCopy').textContent = 0;
            document.getElementById('overallProgressBar').style.width = '0%';
        }

        // 拼音到中文的映射表
        const nameMap = {
            'zhicaowu': '制草乌',
            'qianghuo': '羌活',
            'duhuo': '独活',
            'chaotaoren': '炒桃仁',
            'tougucao': '透骨草',
            'xiakucao': '夏枯草',
            'shenghuangqi': '生黄芪',
            'chaobaishu': '炒白术'
            // ...如有其它药品请补全
        };

        // 当配药过程更新时，刷新界面数据
        function renderDispensing(data) {
            // 1. 顶部信息
            document.getElementById('prescriptionId').textContent = data.id || '--';
            document.getElementById('patientName').textContent = data.patientName || '--';
            document.getElementById('dispenseTime').textContent = data.time || '--';
            // 2. 份数与进度条
            const totalCopies = typeof data.copies === 'number' ? data.copies : (data.copies ? parseInt(data.copies) : 0);
            let actualCopies = typeof data.actualCopies === 'number' ? data.actualCopies : (data.actualCopies ? parseInt(data.actualCopies) : 0);
            actualCopies = Math.min(actualCopies, totalCopies); // 前端保护
            document.getElementById('currentCopy').textContent = actualCopies;
            document.getElementById('totalCopy').textContent = totalCopies;
            let percent = 0;
            if (totalCopies > 0) {
                percent = Math.round((actualCopies / totalCopies) * 100);
                percent = Math.min(percent, 100); // 最大不超过100
            }
            document.getElementById('overallProgressBar').style.width = percent + '%';
            // 3. 药材表格
            const detailBody = document.getElementById('prescriptionDetail');
            detailBody.innerHTML = '';
            let allFinished = true;
            // 兼容actualMedicines为二维数组（每份明细），显示最新一份的实际克数
            let lastActualArr = null;
            if (Array.isArray(data.actualMedicines) && Array.isArray(data.actualMedicines[0])) {
                lastActualArr = data.actualMedicines[data.actualMedicines.length-1];
            } else if (Array.isArray(data.actualMedicines)) {
                lastActualArr = data.actualMedicines;
            }
            if (data.medicines && data.medicines.length > 0) {
                const forceAllFinished = (percent === 100);
                data.medicines.forEach(med => {
                    let actualWeight = '--', statusText = '未配完', statusClass = 'status-wait';
                    if (lastActualArr) {
                        const found = lastActualArr.find(m => nameMap[m.name] === med.name || m.name === med.name);
                        if (found) {
                            actualWeight = found.weight + 'g';
                            if (forceAllFinished || parseFloat(found.weight) >= 0.99 * parseFloat(med.weight)) {
                                statusText = '已配';
                                statusClass = 'status-finished';
                            } else {
                                statusText = '未配完';
                                statusClass = 'status-wait';
                                allFinished = false;
                            }
                        } else {
                            if (forceAllFinished) {
                                statusText = '已配';
                                statusClass = 'status-finished';
                            } else {
                                allFinished = false;
                            }
                        }
                    } else {
                        if (forceAllFinished) {
                            statusText = '已配';
                            statusClass = 'status-finished';
                        } else {
                            allFinished = false;
                        }
                    }
                    detailBody.innerHTML += `<tr><td>${med.name}</td><td>${med.weight}g</td><td>${actualWeight}</td><td class="${statusClass}">${statusText}</td></tr>`;
                });
            }
            if (percent === 100 && allFinished && !window._dispenseFinishAlerted) {
                window._dispenseFinishAlerted = true;
                setTimeout(() => {
                    alert(`药单${data.id || ''}已配完！`);
                    window._dispenseFinishAlerted = false;
                }, 300);
            }
        }

        document.getElementById('pauseBtn').onclick = function() {
            fetch('/api/dispense/pause', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if(data.success) alert('配药已暂停');
                    else alert('暂停失败：' + (data.error || '未知错误'));
                });
        };
        document.getElementById('restartBtn').onclick = function() {
            if(confirm('确定要重新配药吗？这将重置当前进度！')) {
                fetch('/api/dispense/restart', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        if(data.success) alert('已重新开始配药');
                        else alert('重置失败：' + (data.error || '未知错误'));
                    });
            }
        };
    </script>
</body>
</html> 